"use strict";const n=require("electron"),u=require("node:os"),r=require("node:path"),t=require("electron-updater");function w(a){t.autoUpdater.autoDownload=!1,t.autoUpdater.disableWebInstaller=!1,t.autoUpdater.allowDowngrade=!1,t.autoUpdater.on("checking-for-update",function(){}),t.autoUpdater.on("update-available",e=>{a.webContents.send("update-can-available",{update:!0,version:n.app.getVersion(),newVersion:e==null?void 0:e.version})}),t.autoUpdater.on("update-not-available",e=>{a.webContents.send("update-can-available",{update:!1,version:n.app.getVersion(),newVersion:e==null?void 0:e.version})}),n.ipcMain.handle("check-update",async()=>{if(!n.app.isPackaged){const e=new Error("The update feature is only available after the package.");return{message:e.message,error:e}}try{return await t.autoUpdater.checkForUpdatesAndNotify()}catch(e){return{message:"Network error",error:e}}}),n.ipcMain.handle("start-download",e=>{f((s,c)=>{s?e.sender.send("update-error",{message:s.message,error:s}):e.sender.send("download-progress",c)},()=>{e.sender.send("update-downloaded")})}),n.ipcMain.handle("quit-and-install",()=>{t.autoUpdater.quitAndInstall(!1,!0)})}function f(a,e){t.autoUpdater.on("download-progress",s=>a(null,s)),t.autoUpdater.on("error",s=>a(s,null)),t.autoUpdater.on("update-downloaded",e),t.autoUpdater.downloadUpdate()}process.env.DIST_ELECTRON=r.join(__dirname,"../");process.env.DIST=r.join(process.env.DIST_ELECTRON,"../dist");process.env.VITE_PUBLIC=process.env.VITE_DEV_SERVER_URL?r.join(process.env.DIST_ELECTRON,"../public"):process.env.DIST;u.release().startsWith("6.1")&&n.app.disableHardwareAcceleration();process.platform==="win32"&&n.app.setAppUserModelId(n.app.getName());n.app.requestSingleInstanceLock()||(n.app.quit(),process.exit(0));let o=null;const d=r.join(__dirname,"../preload/index.js"),i=process.env.VITE_DEV_SERVER_URL,l=r.join(process.env.DIST,"index.html");async function p(){o=new n.BrowserWindow({title:"Main window",icon:r.join(process.env.VITE_PUBLIC,"favicon.ico"),webPreferences:{preload:d,nodeIntegration:!0,contextIsolation:!1}}),i?(o.loadURL(i),o.webContents.openDevTools()):o.loadFile(l),o.webContents.on("did-finish-load",()=>{o==null||o.webContents.send("main-process-message",new Date().toLocaleString())}),o.webContents.setWindowOpenHandler(({url:a})=>(a.startsWith("https:")&&n.shell.openExternal(a),{action:"deny"})),w(o)}n.app.whenReady().then(p);n.app.on("window-all-closed",()=>{o=null,process.platform!=="darwin"&&n.app.quit()});n.app.on("second-instance",()=>{o&&(o.isMinimized()&&o.restore(),o.focus())});n.app.on("activate",()=>{const a=n.BrowserWindow.getAllWindows();a.length?a[0].focus():p()});n.ipcMain.handle("open-win",(a,e)=>{const s=new n.BrowserWindow({webPreferences:{preload:d,nodeIntegration:!0,contextIsolation:!1}});process.env.VITE_DEV_SERVER_URL?s.loadURL(`${i}#${e}`):s.loadFile(l,{hash:e})});
